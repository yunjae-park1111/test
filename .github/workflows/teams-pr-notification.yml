name: PR Notify to Teams

on:
  pull_request:
    types: [review_requested]
    branches:
      - main
      - dev
      - 'release-v*'
      - 'epic/#*'

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    concurrency:
      group: teams-pr-${{ github.event.pull_request.number }}-${{ github.workflow }}
      cancel-in-progress: true
    timeout-minutes: 3
    steps:
      - name: Send Adaptive Card to Teams
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          # í•„ìˆ˜ ë¹„ë°€ê°’ í™•ì¸
          if [ -z "${TEAMS_WEBHOOK_URL:-}" ]; then
            echo "TEAMS_WEBHOOK_URL ì´(ê°€) ì„¤ì •ë˜ì§€ ì•Šì•„ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          # PR ê¸°ë³¸ ì •ë³´
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          REPOSITORY="${{ github.repository }}"

          # GitHub Variablesì—ì„œ ì‚¬ìš©ì ì´ë©”ì¼ ë§¤í•‘ ê°€ì ¸ì˜¤ê¸°
          USER_EMAIL_MAP="${{ vars.USER_EMAIL_MAP }}"
          if [ -z "$USER_EMAIL_MAP" ]; then
            echo "âŒ USER_EMAIL_MAP Variableì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "ğŸ”§ Repository Settings > Secrets and variables > Actions > Variablesì—ì„œ ì„¤ì •í•´ì£¼ì„¸ìš”."
            echo "ğŸ“‹ ì˜ˆì‹œ í˜•ì‹: {\"pyj\":\"yunjae.park@thakicloud.co.kr\",\"username\":\"email@thakicloud.co.kr\"}"
            exit 1
          fi

          # ë¦¬ë·°ì–´ ëª©ë¡ì—ì„œ coderabbit ê³„ì • ì œê±°
          REVIEWER_LOGINS=$(jq -r '[.pull_request.requested_reviewers[]?.login
            | select(. != "coderabbit" and . != "coderabbitai" and . != "coderabbit[bot]")][]' "$GITHUB_EVENT_PATH")

          # ê° ë¦¬ë·°ì–´ì˜ ì´ë©”ì¼ ì¡°íšŒ ë° ë©˜ì…˜ ì •ë³´ ìƒì„±
          ALL_REVIEWERS=""
          MENTION_ENTITIES=""
          MENTION_TEXT=""
          FAILED_USERS=""

          add_mention() {
            local email=$1
            local username=$(echo "$email" | cut -d'@' -f1)
            ALL_REVIEWERS="${ALL_REVIEWERS}${ALL_REVIEWERS:+, }$email"
            MENTION_ENTITIES="${MENTION_ENTITIES}${MENTION_ENTITIES:+,}{\"type\":\"mention\",\"text\":\"<at>$username</at>\",\"mentioned\":{\"id\":\"$email\",\"name\":\"$username\"}}"
            MENTION_TEXT="$MENTION_TEXT<at>$username</at> "
          }

          for login in $REVIEWER_LOGINS; do
            email=$(echo "$USER_EMAIL_MAP" | jq -r --arg login "$login" '.[$login] // empty')
            if [ -n "$email" ] && [ "$email" != "null" ]; then
              add_mention "$email"
            else
              FAILED_USERS="${FAILED_USERS}${FAILED_USERS:+, }$login"
              ALL_REVIEWERS="${ALL_REVIEWERS}${ALL_REVIEWERS:+, }$login"
            fi
          done


          # íŒ€ ë¦¬ë·°ì–´ ì²˜ë¦¬
          TEAM_REVIEWERS_JSON=$(jq -r '[.pull_request.requested_teams[]?.name]' "$GITHUB_EVENT_PATH")
          TEAM_REVIEWERS_LIST=$(echo "$TEAM_REVIEWERS_JSON" | jq -r '.[]')
          TEAM_REVIEWERS=""

          # ai-platform-teamì´ ìˆìœ¼ë©´ íŒ€ ë©¤ë²„ ì „ì²´ ë©˜ì…˜
          for team in $TEAM_REVIEWERS_LIST; do
            if [ "$team" = "ai-platform-team" ]; then
              echo "ğŸ” ai-platform-team ë©¤ë²„ë“¤ì„ ì¡°íšŒí•©ë‹ˆë‹¤..."
              TEAM_MEMBERS=$(curl -sSf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/orgs/ThakiCloud/teams/ai-platform-team/members" | jq -r '.[].login')

              for member in $TEAM_MEMBERS; do
                email=$(echo "$USER_EMAIL_MAP" | jq -r --arg login "$member" '.[$login] // empty')
                if [ -n "$email" ] && [ "$email" != "null" ]; then
                  add_mention "$email"
                else
                  FAILED_USERS="${FAILED_USERS}${FAILED_USERS:+, }$member"
                  ALL_REVIEWERS="${ALL_REVIEWERS}${ALL_REVIEWERS:+, }$member"
                fi
              done
            else
              TEAM_REVIEWERS="${TEAM_REVIEWERS}${TEAM_REVIEWERS:+, }$team"
            fi
          done

          # íŒ€ ë©¤ë²„ í¬í•¨í•˜ì—¬ ë§¤í•‘ë˜ì§€ ì•Šì€ ì‚¬ìš©ìê°€ ìˆìœ¼ë©´ ì‹¤íŒ¨ ì²˜ë¦¬
          if [ -n "$FAILED_USERS" ]; then
            echo "âŒ ë‹¤ìŒ ì‚¬ìš©ìë“¤ì˜ ì´ë©”ì¼ ë§¤í•‘ì´ ì—†ìŠµë‹ˆë‹¤: $FAILED_USERS"
            echo "USER_EMAIL_MAP Secretì— ì¶”ê°€í•´ì£¼ì„¸ìš”: {\"username\":\"email@thakicloud.co.kr\"}"
            exit 1
          fi

          MENTION_TEXT=$(echo "$MENTION_TEXT" | sed 's/ *$//')
          REVIEWERS=$(printf "%s%s%s" "$ALL_REVIEWERS" "${ALL_REVIEWERS:+, }" "$TEAM_REVIEWERS" | sed 's/^, //; s/, $//')

          # coderabbitë§Œ í• ë‹¹ëœ ê²½ìš°ë‚˜ ë¦¬ë·°ì–´ê°€ ì—†ëŠ” ê²½ìš° ì•Œë¦¼ ì¤‘ë‹¨
          if [ -z "$(echo "$REVIEWERS" | tr -d '[:space:],')" ]; then
            echo "ì‹¤ì œ ë¦¬ë·°ì–´ê°€ ì—†ìŠµë‹ˆë‹¤ (coderabbitë§Œ í• ë‹¹ë¨ ë˜ëŠ” ë¦¬ë·°ì–´ ì—†ìŒ). ì•Œë¦¼ì„ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 0
          fi

          # Adaptive Card JSON ìƒì„± (ì•ˆì „í•œ jq ì‚¬ìš©)
          ENTITIES_JSON="[$MENTION_ENTITIES]"
          TITLE_TEXT="${MENTION_TEXT:+$MENTION_TEXT }[$REPOSITORY] PR ë¦¬ë·° ìš”ì²­"

          PAYLOAD=$(jq -n \
            --arg repo "$REPOSITORY" \
            --arg title "$PR_TITLE" \
            --arg author "$PR_AUTHOR" \
            --arg branches "$PR_BRANCH â†’ $TARGET_BRANCH" \
            --arg repository "$REPOSITORY" \
            --arg reviewers "$REVIEWERS" \
            --arg url "$PR_URL" \
            --arg title_text "$TITLE_TEXT" \
            --argjson mention_entities "$ENTITIES_JSON" \
            '{
              "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
              "type": "AdaptiveCard",
              "version": "1.5",
              "msteams": {
                "width": "Full",
                "entities": $mention_entities
              },
              "body": [
                {"type": "TextBlock", "text": $title_text, "size": "Large", "weight": "Bolder", "wrap": true},
                {"type": "FactSet", "facts": [
                  {"title": "PR ì œëª©", "value": $title},
                  {"title": "ì‘ì„±ì", "value": $author},
                  {"title": "ë¸Œëœì¹˜", "value": $branches},
                  {"title": "ë¦¬í¬ì§€í† ë¦¬", "value": $repository},
                  {"title": "ë¦¬ë·°ì–´", "value": $reviewers}
                ]},
                {"type": "ActionSet", "actions": [
                  {"type": "Action.OpenUrl", "title": "PR ë³´ê¸°", "url": $url}
                ]}
              ]
            }')

          # ì „ì†¡ ë° ì—ëŸ¬ ì²˜ë¦¬
          curl -sSf --retry 3 --retry-all-errors --connect-timeout 5 --max-time 10 \
               -X POST -H 'Content-Type: application/json' \
               -d "$PAYLOAD" \
               "$TEAMS_WEBHOOK_URL"
